name: "Manual Infrastructure Deployment"

on:
  workflow_dispatch:  # âœ… Manual trigger

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  KEY_VAULT_NAME: ${{ secrets.AZURE_KEY_VAULT_NAME }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  deploy-infrastructure:
    name: "Deploy Infrastructure"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v3

      - name: "Login to Azure"
        run: |
          az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
          az account set --subscription $AZURE_SUBSCRIPTION_ID

      - name: "Fetch Secrets from Azure Key Vault"
        id: keyvault
        run: |
          echo "Fetching database connection string..."
          DB_CONNECTION_STRING=$(az keyvault secret show --name DBConnectionString --vault-name $KEY_VAULT_NAME --query value -o tsv)
          echo "::set-output name=db_connection_string::$DB_CONNECTION_STRING"

      - name: "Deploy Infrastructure using Bicep"
        run: |
          echo "Starting deployment with database mode: ${{ github.event.inputs.databaseType }}"

          az deployment group create \
            --resource-group $RESOURCE_GROUP \
            --template-file Infrastructure/main.bicep \
            --parameters databaseType=${{ github.event.inputs.databaseType }} \
                         eventStorageType=${{ github.event.inputs.eventStorageType }} \
                         entityStorageType=${{ github.event.inputs.entityStorageType }} \
                         environment=dev \
                         DBConnectionString=${{ steps.keyvault.outputs.db_connection_string }}
