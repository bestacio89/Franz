name: "Docker Build & Push to AWS ECR"
runs-on: ubuntu-latest

env:
  AWS_REGION: "us-east-1"
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_ECR_URL: ${{ secrets.AWS_ECR_URL }}
  REPOSITORY: ${{ secrets.SERVICE_NAME }}  # Replace with your microservice name

steps:
  - name: "Checkout Repository"
    uses: actions/checkout@v3

  - name: "Login to AWS ECR"
    run: |
      aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ECR_URL

  - name: "Build Docker Image"
    run: |
      docker build -t $REPOSITORY:latest sources/back/Franz.Api/

  - name: "Tag Docker Image"
    run: |
      docker tag $REPOSITORY:latest $AWS_ECR_URL/$REPOSITORY:latest
      docker tag $REPOSITORY:latest $AWS_ECR_URL/$REPOSITORY:${{ github.run_id }}

  - name: "Push Docker Image to AWS ECR"
    run: |
      docker push $AWS_ECR_URL/$REPOSITORY:latest
      docker push $AWS_ECR_URL/$REPOSITORY:${{ github.run_id }}
