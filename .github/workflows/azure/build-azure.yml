name: "Build and Test .NET Solution"

on:
  push:
    branches:
      - Develop  # âœ… Trigger only on Develop branch pushes
  pull_request:
    branches:
      - Develop  # âœ… Run on PRs targeting Develop
  workflow_dispatch:  # âœ… Allow manual triggers

env:
  BUILD_PLATFORM: "Any CPU"
  BUILD_CONFIGURATION: "Release"

jobs:
  build-and-test:
    name: "ğŸ› ï¸ Build & Test .NET Solution"
    runs-on: windows-latest

    steps:
      # Step 1: Checkout Repository
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      # Step 2: Setup NuGet
      - name: "ğŸ“¦ Setup NuGet"
        uses: nuget/setup-nuget@v1

      # Step 3: Cache NuGet packages
      - name: "âš¡ Cache NuGet Packages"
        uses: actions/cache@v3
        with:
          path: |
            ~/.nuget/packages
            ~/.nuget/NuGet.Config
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      # Step 4: Restore NuGet Packages
      - name: "ğŸ“¥ Restore NuGet Packages"
        run: nuget restore "**/*.sln"

      # Step 5: Setup .NET SDK (pin exact version for stability)
      - name: "ğŸ› ï¸ Setup .NET SDK"
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "6.0.420" # âœ… Pin specific version instead of floating

      # Step 6: Build Solution
      - name: "ğŸ—ï¸ Build Solution"
        run: |
          msbuild "**/*.sln" `
            /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
            /p:Platform="${{ env.BUILD_PLATFORM }}" `
            /p:ExcludeProjects="**/Franz.DockerCompose/Franz.DockerCompose.dcproj"

      # Step 7: Run Automated Tests (unit tests only, skip integration if needed)
      - name: "ğŸ§ª Run Automated Tests"
        run: |
          dotnet test "**/*.sln" `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --logger "trx;LogFileName=test_results.trx" `
            --results-directory TestResults `
            --filter TestCategory!=Integration

      # Step 8: Publish Test Results
      - name: "ğŸ“Š Publish Test Results"
        uses: dorny/test-reporter@v1
        if: always() # âœ… Ensure results are published even if tests fail
        with:
          name: "Test Report"
          path: "TestResults/*.trx"
          reporter: dotnet-trx

      # Step 9: Upload Build Artifacts (optional)
      - name: "â¬†ï¸ Upload Build Artifacts"
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            **/bin/${{ env.BUILD_CONFIGURATION }}/
            TestResults/
          retention-days: 7
