name: "Deploy to GCP"

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "Repository Name"
        required: true
        default: "Franz"
      serviceName:
        description: "Microservice Name"
        required: true
        default: "microservice"
      gcpArtifactRegistry:
        description: "GCP Artifact Registry URL (e.g., us-central1-docker.pkg.dev/project/repo)"
        required: true
        default: "<GCP_ARTIFACT_REGISTRY>"
      deployTarget:
        description: "Deployment target"
        required: true
        default: "cloudrun"
        type: choice
        options:
          - gke
          - cloudrun

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: "us-central1"
  GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}

jobs:
  # ============================================
  # ‚úÖ BUILD & PUSH DOCKER IMAGE
  # ============================================
  build-and-push:
    name: "üê≥ Build & Push Docker Image"
    runs-on: ubuntu-latest
    steps:
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4

      - name: "üîë Authenticate with GCP"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ env.GCP_CREDENTIALS }}"

      - name: "‚öôÔ∏è Configure Docker for Artifact Registry"
        run: |
          gcloud auth configure-docker ${{ github.event.inputs.gcpArtifactRegistry }} --quiet

      - name: "üê≥ Build & Push Image"
        run: |
          IMAGE="${{ github.event.inputs.gcpArtifactRegistry }}/${{ github.event.inputs.serviceName }}:${{ github.sha }}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: "üì¶ Save Image Info"
        run: |
          echo "{ \"image\": \"$IMAGE\" }" > image-info.json
        shell: bash

      - name: "‚¨ÜÔ∏è Upload Image Artifact"
        uses: actions/upload-artifact@v3
        with:
          name: image-info
          path: image-info.json

  # ============================================
  # ‚úÖ DEPLOY TO GKE
  # ============================================
  deploy-gke:
    if: ${{ github.event.inputs.deployTarget == 'gke' }}
    needs: build-and-push
    name: "üöÄ Deploy to GKE"
    runs-on: ubuntu-latest
    steps:
      - name: "üîë Authenticate with GCP"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ env.GCP_CREDENTIALS }}"

      - name: "‚öôÔ∏è Get GKE Credentials"
        run: |
          gcloud container clusters get-credentials ${{ github.event.inputs.serviceName }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: "üì• Download Image Artifact"
        uses: actions/download-artifact@v3
        with:
          name: image-info

      - name: "üöÄ Apply Deployment"
        run: |
          IMAGE=$(jq -r .image image-info.json)
          kubectl set image deployment/${{ github.event.inputs.serviceName }} \
            ${{ github.event.inputs.serviceName }}=$IMAGE
          kubectl rollout status deployment/${{ github.event.inputs.serviceName }} --timeout=120s

  # ============================================
  # ‚úÖ DEPLOY TO CLOUD RUN
  # ============================================
  deploy-cloudrun:
    if: ${{ github.event.inputs.deployTarget == 'cloudrun' }}
    needs: build-and-push
    name: "üöÄ Deploy to Cloud Run"
    runs-on: ubuntu-latest
    steps:
      - name: "üîë Authenticate with GCP"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ env.GCP_CREDENTIALS }}"

      - name: "üì• Download Image Artifact"
        uses: actions/download-artifact@v3
        with:
          name: image-info

      - name: "üöÄ Deploy to Cloud Run"
        run: |
          IMAGE=$(jq -r .image image-info.json)
          gcloud run deploy ${{ github.event.inputs.serviceName }} \
            --image $IMAGE \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --quiet
          gcloud run services describe ${{ github.event.inputs.serviceName }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)' > service-url.txt

      - name: "‚¨ÜÔ∏è Upload Cloud Run URL"
        uses: actions/upload-artifact@v3
        with:
          name: cloudrun-url
          path: service-url.txt
