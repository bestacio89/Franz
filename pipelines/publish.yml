pr: none   # âŒ Prevent auto-trigger on PRs
trigger: none   # âŒ Ensure manual execution only

parameters:
  - name: repository
    displayName: Repository Name
    default: Franz

  - name: major
    displayName: Major Version {x.0.0}
    type: number
    default: 2

  - name: minor
    displayName: Minor Version {1.x.0}
    type: number
    default: 1

  - name: patch
    displayName: Patch Version {1.0.x}
    type: string
    default: 5

  - name: frontEndType
    displayName: "Front-End Type"
    type: string
    default: "Blazor"
    values:
      - Angular
      - Blazor
      - ASP.NET

variables:
  - group: "Azure Variables"  # âœ… Environment-specific vars
  - name: imageTag
    value: ${{ parameters.major }}.${{ parameters.minor }}.${{ parameters.patch }}

stages:
# ========================================
# âœ… BUILD FRONTEND STAGE
# ========================================
- stage: Build_Frontend
  displayName: "ðŸš€ Build Frontend"
  jobs:
    - job: DockerBuildFrontend
      displayName: "ðŸ³ Docker Build & Push Frontend"
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - script: |
            echo ">> Detecting frontend type: ${{ parameters.frontEndType }}"
            if [ "${{ parameters.frontEndType }}" == "Angular" ]; then
              echo "##vso[task.setvariable variable=dockerfilePath]sources/front/FranzFront.Angular/Dockerfile"
              echo "##vso[task.setvariable variable=buildContext]sources/front/FranzFront.Angular"
            elif [ "${{ parameters.frontEndType }}" == "Blazor" ]; then
              echo "##vso[task.setvariable variable=dockerfilePath]sources/front/FranzFront.Blazor/Client/Dockerfile"
              echo "##vso[task.setvariable variable=buildContext]sources/front/FranzFront.Blazor"
            else
              echo "##vso[task.setvariable variable=dockerfilePath]sources/front/FranzFront.ASPNET/Dockerfile"
              echo "##vso[task.setvariable variable=buildContext]sources/front/FranzFront.ASPNET"
            fi
          displayName: "âš™ï¸ Set Docker Build Context"

        - task: Docker@2
          displayName: "ðŸ³ Build & Push Frontend Image"
          inputs:
            containerRegistry: $(AZURE_CONTAINER_REGISTRY)
            repository: "${{ parameters.repository }}-frontend-${{ parameters.frontEndType | toLower }}"
            dockerfile: "$(dockerfilePath)"
            buildContext: "$(buildContext)"
            command: buildAndPush
            tags: |
              $(imageTag)
              latest

        - script: |
            echo "{ \"frontend\": \"${{ parameters.repository }}-frontend-${{ parameters.frontEndType | toLower }}:$(imageTag)\" }" > $(Build.ArtifactStagingDirectory)/frontend-image.json
          displayName: "ðŸ“¦ Save Frontend Image Tag"

        - publish: $(Build.ArtifactStagingDirectory)/frontend-image.json
          artifact: frontend-image

# ========================================
# âœ… BUILD BACKEND STAGE
# ========================================
- stage: Build_Backend
  displayName: "ðŸš€ Build Backend"
  dependsOn: Build_Frontend
  jobs:
    - job: DockerBuildBackend
      displayName: "ðŸ³ Docker Build & Push Backend"
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - task: Docker@2
          displayName: "ðŸ³ Build & Push API Image"
          inputs:
            containerRegistry: $(AZURE_CONTAINER_REGISTRY)
            repository: "${{ parameters.repository }}-api"
            dockerfile: "sources/back/Franz.Api/Dockerfile"
            buildContext: "sources/back/Franz.Api"
            command: buildAndPush
            tags: |
              $(imageTag)
              latest

        - task: Docker@2
          displayName: "ðŸ³ Build & Push Consumer Image"
          inputs:
            containerRegistry: $(AZURE_CONTAINER_REGISTRY)
            repository: "${{ parameters.repository }}-consumer"
            dockerfile: "sources/back/Franz.Backend/Consumer/Dockerfile"
            buildContext: "sources/back/Franz.Backend/Consumer"
            command: buildAndPush
            tags: |
              $(imageTag)
              latest

        - script: |
            echo "{ 
              \"api\": \"${{ parameters.repository }}-api:$(imageTag)\",
              \"consumer\": \"${{ parameters.repository }}-consumer:$(imageTag)\" 
            }" > $(Build.ArtifactStagingDirectory)/backend-images.json
          displayName: "ðŸ“¦ Save Backend Image Tags"

        - publish: $(Build.ArtifactStagingDirectory)/backend-images.json
          artifact: backend-images
