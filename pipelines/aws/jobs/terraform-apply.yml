- job: Terraform_Apply
  displayName: "Terraform Apply"
  dependsOn: Terraform_Plan
  steps:
    # -------------------------------
    # ‚úÖ Check if Kafka already exists
    # -------------------------------
    - script: |
        echo "üîé Checking if Kafka Hub already exists..."
        EXISTING_KAFKA=$(aws kafka list-clusters \
          --region $(AWS_REGION) \
          --query "ClusterInfoList[?ClusterName=='$(KAFKA_CLUSTER_NAME)'].ClusterName" \
          --output text)

        if [ -n "$EXISTING_KAFKA" ]; then
          echo "‚úÖ Kafka Hub already exists: $EXISTING_KAFKA"
          echo "##vso[task.setvariable variable=KAFKA_EXISTS;]true"
        else
          echo "‚ÑπÔ∏è Kafka Hub does not exist. It will be created."
          echo "##vso[task.setvariable variable=KAFKA_EXISTS;]false"
        fi
      displayName: "Check if Kafka Hub Exists"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

    # -------------------------------
    # ‚úÖ Check if RabbitMQ already exists
    # -------------------------------
    - script: |
        echo "üîé Checking if RabbitMQ broker already exists..."
        EXISTING_RABBIT=$(aws mq list-brokers \
          --region $(AWS_REGION) \
          --query "BrokerSummaries[?BrokerName=='$(RABBITMQ_BROKER_NAME)'].BrokerName" \
          --output text)

        if [ -n "$EXISTING_RABBIT" ]; then
          echo "‚úÖ RabbitMQ broker already exists: $EXISTING_RABBIT"
          echo "##vso[task.setvariable variable=RABBIT_EXISTS;]true"
        else
          echo "‚ÑπÔ∏è RabbitMQ broker does not exist. It will be created."
          echo "##vso[task.setvariable variable=RABBIT_EXISTS;]false"
        fi
      displayName: "Check if RabbitMQ Broker Exists"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

    # -------------------------------
    # ‚úÖ Conditional Terraform Apply
    # -------------------------------
    - script: |
        if [ "$KAFKA_EXISTS" = "true" ] && [ "$RABBIT_EXISTS" = "true" ]; then
          echo "‚è© Skipping Terraform apply (Kafka & RabbitMQ already exist)."
        else
          echo "üöÄ Running terraform apply..."
          terraform apply -auto-approve tfplan
        fi
      displayName: "Terraform Apply"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        KAFKA_EXISTS: $(KAFKA_EXISTS)
        RABBIT_EXISTS: $(RABBIT_EXISTS)
