# ========================================
# Azure DevOps Pipeline - Build & Test
# ========================================

trigger:
  branches:
    include:
      - develop   # âœ… Auto-run on develop commits
pr: none          # âŒ Prevent on PR creation

pool:
  vmImage: 'windows-latest'   # âœ… Windows agent for MSBuild + VSTest

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

stages:
- stage: BuildAndTest
  displayName: "ğŸ› ï¸ Build and Test"
  jobs:
  - job: BuildTest
    displayName: "ğŸ”¨ Build & Run Tests"
    steps:

    # ----------------------------------------
    # âœ… NuGet Setup & Cache
    # ----------------------------------------
    - task: NuGetToolInstaller@1
      displayName: "ğŸ“¦ Install NuGet"

    - task: Cache@2
      inputs:
        key: 'nuget | "$(Agent.OS)" | **/packages.lock.json'
        restoreKeys: |
          nuget | "$(Agent.OS)"
        path: $(NuGetPackageRoot)
      displayName: "âš¡ Cache NuGet Packages"

    # ----------------------------------------
    # âœ… Restore Packages
    # ----------------------------------------
    - task: NuGetCommand@2
      inputs:
        restoreSolution: '$(solution)'
        feedsToUse: 'config'
        nugetConfigPath: 'nuget.config'
      displayName: "ğŸ“¦ Restore NuGet Packages"

    # ----------------------------------------
    # âœ… Build Solution
    # ----------------------------------------
    - task: VSBuild@1
      inputs:
        solution: '$(solution)'
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'
        msbuildArgs: '/p:ExcludeProjects="**/Franz.DockerCompose/Franz.DockerCompose.dcproj"'
      displayName: "ğŸ”¨ Build Solution"

    # ----------------------------------------
    # âœ… Run Unit Tests (skip integration)
    # ----------------------------------------
    - task: VSTest@2
      inputs:
        testAssemblyVer2: |
          **\*test*.dll
          !**\*TestAdapter.dll
          !**\obj\**
        testFiltercriteria: 'Category!=Integration'   # ğŸ‘ˆ skip Integration tests
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'
        diagnosticsEnabled: true
      displayName: "ğŸ§ª Run Unit Tests (skip Integration)"

    # ----------------------------------------
    # âœ… Publish Test Results
    # ----------------------------------------
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/TestResults/*.trx'
        failTaskOnFailedTests: true
      condition: succeededOrFailed()
      displayName: "ğŸ“Š Publish Test Results"

    # ----------------------------------------
    # âœ… Publish Build Artifacts
    # ----------------------------------------
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'
        publishLocation: 'Container'
      displayName: "ğŸ“¦ Publish Build Artifacts"
