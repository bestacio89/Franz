parameters:
  repository: ''
  workdir: ''
  registry: ''
  dockerfile: ''
  version: ''

jobs:
- job: Publish
  displayName: "ğŸ“¦ Publish Docker Image"
  pool:
    vmImage: 'ubuntu-latest'
        
  steps:
    # ----------------------------------------
    # ğŸ”‘ Step 1: Login to ACR
    # ----------------------------------------
    - task: Docker@2
      displayName: "ğŸ”‘ Login to ACR"
      inputs:
        command: login 
        containerRegistry: ${{ parameters.registry }}

    # ----------------------------------------
    # ğŸ³ Step 2: Build & Push Docker image
    # ----------------------------------------
    - task: Docker@2
      displayName: "ğŸ³ Build & Push Docker Image"
      inputs:
        command: buildAndPush
        repository: ${{ parameters.repository }}
        containerRegistry: ${{ parameters.registry }}
        dockerfile: ${{ parameters.dockerfile }}
        buildContext: ${{ parameters.workdir }}
        tags: |
          ${{ parameters.version }}
          latest

    # ----------------------------------------
    # ğŸ“¤ Step 3: Export Image Tag for Deploy Pipelines
    # ----------------------------------------
    - bash: |
        echo "Writing image tag to artifact..."
        echo "{\"image\": \"${{ parameters.repository }}:${{ parameters.version }}\"}" > image-info.json
        cat image-info.json
      displayName: "ğŸ“¤ Save Image Tag"

    - publish: image-info.json
      artifact: docker-image-info
      displayName: "ğŸ“¦ Publish Image Tag Artifact"
