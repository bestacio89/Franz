pr: none
trigger: none   # Manual only

parameters:
  - name: databaseType
    type: string
    default: "single"
    values: [ single, multi ]

  - name: eventStorageType
    type: string
    default: "Kafka"
    values: [ Kafka, CosmosDB, MongoDB ]

  - name: entityStorageType
    type: string
    default: "SQLServer"
    values: [ PostgreSQL, MariaDB, MySQL, SQLServer, Oracle ]

  - name: messagingType
    type: string
    default: "Kafka"
    values: [ Kafka, RabbitMQ, Both, None ]

  - name: environment
    type: string
    default: "dev"
    values: [ dev, staging, prod ]

  - name: containerImage
    type: string
    default: ""   # injected from build pipeline

variables:
  # ðŸ‘‡ Dynamic environment-specific variable group
  - group: Variables-${{ parameters.environment }}

jobs:
- job: Deploy
  displayName: "ðŸš€ Infra Deployment"
  pool:
    vmImage: 'ubuntu-latest'

  steps:
    # ðŸ”‘ Fetch DB Secret (optional â€“ only if not using Key Vault refs in var group)
    - task: AzureCLI@2
      displayName: "ðŸ”‘ Fetch Secrets from Key Vault"
      condition: ne('${{ parameters.environment }}','') # skip if not needed
      inputs:
        azureSubscription: 'your-azure-subscription'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          DB_CONNECTION_STRING=$(az keyvault secret show \
            --name DBConnectionString \
            --vault-name $(keyVaultName) \
            --query value -o tsv)

          echo "##vso[task.setvariable variable=DB_CONNECTION_STRING;isSecret=true]$DB_CONNECTION_STRING"

    # ðŸš€ Deploy with Bicep
    - task: AzureCLI@2
      displayName: "ðŸš€ Deploy Infra with Bicep"
      inputs:
        azureSubscription: 'your-azure-subscription'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "===================================="
          echo "ðŸŒ Env:         ${{ parameters.environment }}"
          echo "ðŸ—„ï¸ DB:          ${{ parameters.databaseType }}"
          echo "ðŸ“‚ Event:       ${{ parameters.eventStorageType }}"
          echo "ðŸ“‚ Entity:      ${{ parameters.entityStorageType }}"
          echo "ðŸ“© Messaging:   ${{ parameters.messagingType }}"
          echo "ðŸ³ Image:       ${{ parameters.containerImage }}"
          echo "===================================="

          # Explicit per-environment deployment name
          az deployment group create \
            --resource-group $(resourceGroupName) \
            --name main-${{ parameters.environment }} \
            --template-file main.bicep \
            --mode Incremental \
            --only-show-errors \
            --parameters \
              databaseType=${{ parameters.databaseType }} \
              eventStorageType=${{ parameters.eventStorageType }} \
              entityStorageType=${{ parameters.entityStorageType }} \
              messagingType=${{ parameters.messagingType }} \
              environment=${{ parameters.environment }} \
              containerImage=${{ parameters.containerImage }} \
              DBConnectionString=$(DB_CONNECTION_STRING)

    # ðŸ“¤ Capture Outputs
    - task: AzureCLI@2
      displayName: "ðŸ“¤ Capture Bicep Outputs"
      inputs:
        azureSubscription: 'your-azure-subscription'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          outputs=$(az deployment group show \
            -g $(resourceGroupName) \
            -n main-${{ parameters.environment }} \
            --query properties.outputs)
          
          echo "ðŸ”Ž Raw Outputs: $outputs"

          # Export outputs as pipeline variables
          echo $outputs | jq -r 'to_entries|.[]| "##vso[task.setvariable variable=\(.key);isOutput=true]\(.value.value)"'

          # Persist outputs to artifact file
          echo $outputs > $(Build.ArtifactStagingDirectory)/infra-outputs.json

    # ðŸ“¦ Publish Outputs as Artifact
    - publish: $(Build.ArtifactStagingDirectory)/infra-outputs.json
      artifact: infra-outputs-${{ parameters.environment }}
      displayName: "ðŸ“¦ Publish Infra Outputs"
