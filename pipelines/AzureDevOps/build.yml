# ========================================
# ğŸ§  Franz Audit Suite - Build & Test Pipeline
# ========================================
# âœ… Purpose:
#   Automated build & verification of Franz.Common + Audit Test Suite
#   Ensures all template & DTO logic (Bookâ€“Member etc.) compile & pass unit tests.
# ========================================

# ----------------------------------------
# ğŸ—ï¸ Trigger
# ----------------------------------------
trigger:
  branches:
    include:
      - Develop          # âœ… Run automatically on commits to develop
pr: none                 # âŒ Skip PR validation builds (manual trigger only)

# ----------------------------------------
# ğŸ§© Build Environment
# ----------------------------------------
pool:
  vmImage: 'windows-latest'   # ğŸªŸ Required for MSBuild + VSTest integration

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  artifactName: 'drop'

# ----------------------------------------
# ğŸš€ Stage: Build & Test
# ----------------------------------------
stages:
  - stage: BuildAndTest
    displayName: "ğŸ› ï¸ Build & Run Test Suite"
    jobs:
      - job: BuildTest
        displayName: "ğŸ”¨ Compile + Execute Tests"
        steps:

          # ----------------------------------------
          # ğŸ§° NuGet Setup & Caching
          # ----------------------------------------
          - task: NuGetToolInstaller@1
            displayName: "ğŸ“¦ Install NuGet CLI"

          - task: Cache@2
            displayName: "âš¡ Cache NuGet Packages"
            inputs:
              key: 'nuget | "$(Agent.OS)" | $(Build.SourcesDirectory)/**/*.csproj'
              restoreKeys: |
                nuget | "$(Agent.OS)"
              path: '$(UserProfile)\.nuget\packages'

          # ----------------------------------------
          # ğŸ“¥ Restore Dependencies
          # ----------------------------------------
          - task: NuGetCommand@2
            displayName: "ğŸ“¦ Restore NuGet Packages"
            inputs:
              restoreSolution: '$(solution)'
              feedsToUse: 'select'
              vstsFeed: 'Franz/FranzFeed'    # ğŸ§­ Change to your Azure Artifacts feed
              includeNuGetOrg: true

          # ----------------------------------------
          # ğŸ§± Build Solution
          # ----------------------------------------
          - task: VSBuild@1
            displayName: "ğŸ—ï¸ Build Franz Solution"
            inputs:
              solution: '$(solution)'
              platform: '$(buildPlatform)'
              configuration: '$(buildConfiguration)'
              msbuildArgs: '/restore /verbosity:minimal'
              clean: true
              maximumCpuCount: true
              logProjectEvents: false

          # ----------------------------------------
          # ğŸ§ª Execute Unit Tests
          # ----------------------------------------
          - task: VSTest@2
            displayName: "ğŸ§ª Run Unit Tests (skip Integration)"
            inputs:
              testAssemblyVer2: |
                **\*Tests.dll
                !**\*TestAdapter.dll
                !**\obj\**
              testFiltercriteria: 'TestCategory!=Integration'
              searchFolder: '$(System.DefaultWorkingDirectory)'
              platform: '$(buildPlatform)'
              configuration: '$(buildConfiguration)'
              diagnosticsEnabled: true
              testResultsDirectory: '$(Agent.TempDirectory)/TestResults'
              runInParallel: true
              runSettingsFile: ''
              codeCoverageEnabled: true

          # ----------------------------------------
          # ğŸ“Š Publish Test Results
          # ----------------------------------------
          - task: PublishTestResults@2
            displayName: "ğŸ“Š Publish Unit Test Results"
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '$(Agent.TempDirectory)/**/*.trx'
              failTaskOnFailedTests: true
              mergeTestResults: true

          # ----------------------------------------
          # ğŸ“¦ Copy Build Outputs to Artifact Staging
          # ----------------------------------------
          - task: CopyFiles@2
            displayName: "ğŸ“‚ Collect Compiled Binaries"
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)'
              Contents: '**/bin/$(buildConfiguration)/**'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          # ----------------------------------------
          # ğŸš¢ Publish Build Artifacts
          # ----------------------------------------
          - task: PublishBuildArtifacts@1
            displayName: "ğŸš€ Publish Artifacts to Pipeline"
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: '$(artifactName)'
              publishLocation: 'Container'

# ========================================
# âœ… Notes
# ========================================
#  - Integration tests are skipped via filter (TestCategory!=Integration)
#  - Compatible with xUnit, NUnit, MSTest
#  - Code coverage enabled for analysis
#  - Can extend with a TestContainers or Kafka stage in future
# ========================================
