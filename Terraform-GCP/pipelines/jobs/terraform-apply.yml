- job: terraform-apply
  displayName: "üöÄ Terraform Apply"
  dependsOn: terraform-plan
  pool:
    vmImage: 'ubuntu-latest'

  steps:
    - checkout: self

    # ---------------------------
    # ‚úÖ Check Kafka existence
    # ---------------------------
    - script: |
        echo "üîé Checking if Kafka Hub already exists..."
        EXISTING_KAFKA=$(aws kafka list-clusters \
          --region $(AWS_REGION) \
          --query "ClusterInfoList[?ClusterName=='$(KAFKA_CLUSTER_NAME)'].ClusterName" \
          --output text)

        if [ -n "$EXISTING_KAFKA" ]; then
          echo "‚úÖ Kafka Hub already exists: $EXISTING_KAFKA"
          echo "##vso[task.setvariable variable=KAFKA_EXISTS;isOutput=true]true"
        else
          echo "‚ö†Ô∏è Kafka Hub does not exist. It will be created."
          echo "##vso[task.setvariable variable=KAFKA_EXISTS;isOutput=true]false"
        fi
      displayName: "Check Kafka Hub Exists"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

    # ---------------------------
    # ‚úÖ Check RabbitMQ existence
    # ---------------------------
    - script: |
        echo "üîé Checking if RabbitMQ broker already exists..."
        EXISTING_RABBIT=$(aws mq list-brokers \
          --region $(AWS_REGION) \
          --query "BrokerSummaries[?BrokerName=='$(RABBITMQ_BROKER_NAME)'].BrokerName" \
          --output text)

        if [ -n "$EXISTING_RABBIT" ]; then
          echo "‚úÖ RabbitMQ broker already exists: $EXISTING_RABBIT"
          echo "##vso[task.setvariable variable=RABBIT_EXISTS;isOutput=true]true"
        else
          echo "‚ö†Ô∏è RabbitMQ broker does not exist. It will be created."
          echo "##vso[task.setvariable variable=RABBIT_EXISTS;isOutput=true]false"
        fi
      displayName: "Check RabbitMQ Exists"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

    # ---------------------------
    # ‚úÖ Apply Terraform
    # ---------------------------
    - script: |
        if [ "$(KAFKA_EXISTS)" == "true" ] && [ "$(RABBIT_EXISTS)" == "true" ]; then
          echo "‚è© Skipping Terraform Apply ‚Äî both Kafka & RabbitMQ already exist."
        else
          echo "üöÄ Applying Terraform plan..."
          terraform apply -auto-approve tfplan
        fi
      displayName: "Terraform Apply"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
