jobs:
- job: terraform-init
  displayName: "âš™ï¸ Terraform Init"
  pool:
    vmImage: 'ubuntu-latest'

  parameters:
    environment: ""          # e.g. dev, qa, prod
    workingDirectory: "."    # relative to repo root
    backendConfigDir: "backends"  # directory where backend-*.tfvars are stored

  steps:
    # ---------------------------
    # âœ… Install Terraform
    # ---------------------------
    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: "1.4.6"

    # ---------------------------
    # âœ… Change to working directory
    # ---------------------------
    - script: |
        echo "ğŸ“‚ Switching to working directory: ${{ parameters.workingDirectory }}"
        cd ${{ parameters.workingDirectory }}
        ls -la
      displayName: "Set Working Directory"

    # ---------------------------
    # âœ… Init Terraform backend
    # ---------------------------
    - script: |
        echo "ğŸ” Environment: ${{ parameters.environment }}"
        BACKEND_FILE="${{ parameters.backendConfigDir }}/backend-${{ parameters.environment }}.tfvars"

        if [ ! -f "$BACKEND_FILE" ]; then
          echo "âŒ Backend config not found: $BACKEND_FILE"
          exit 1
        fi

        echo "ğŸš€ Initializing Terraform with backend: $BACKEND_FILE"
        terraform init -backend-config="$BACKEND_FILE"
      displayName: "Initialize Terraform Backend"
      workingDirectory: ${{ parameters.workingDirectory }}
