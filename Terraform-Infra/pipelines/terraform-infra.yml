# ==========================
# âœ… Prevent Auto-Triggers
# ==========================
pr: none
trigger: none  # Prevent automatic runs; only manual or scheduled

# ==========================
# âœ… Parameters
# ==========================
parameters:
  - name: databaseType
    displayName: "Database Type"
    type: string
    default: "single"
    values:
      - single
      - multi

  - name: eventStorageType
    displayName: "Event Storage Type (Only for Multi-DB)"
    type: string
    default: "Kafka"
    values:
      - Kafka
      - CosmosDB
      - MongoDB

  - name: entityStorageType
    displayName: "Entity Storage Type"
    type: string
    default: "SQLServer"
    values:
      - PostgreSQL
      - MariaDB
      - MySQL
      - SQLServer
      - Oracle

  - name: messagingType
    displayName: "Messaging Layer"
    type: string
    default: "Kafka"
    values:
      - Kafka
      - RabbitMQ
      - Both

# ==========================
# âœ… Global Variables
# ==========================
variables:
  - group: AWS_Variables   # Load AWS credentials/region from Library
  - name: TF_VERSION
    value: "1.9.6"         # Pin Terraform version for consistency
  - name: WORKING_DIR
    value: "infra/aws"     # Path to Terraform root module

# ==========================
# âœ… Stages
# ==========================
stages:
  - stage: DeployInfrastructure
    displayName: "ðŸš€ Deploy AWS Infrastructure"
    jobs:

      # ----------------------------
      # âœ… 1. Terraform Initialization
      # ----------------------------
      - job: Terraform_Init
        displayName: "Terraform Init"
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UseTerraform@0
            displayName: "Install Terraform ${{ variables.TF_VERSION }}"
            inputs:
              terraformVersion: ${{ variables.TF_VERSION }}

          - template: jobs/terraform-init.yml
            parameters:
              workingDirectory: ${{ variables.WORKING_DIR }}

      # ----------------------------
      # âœ… 2. Terraform Validate
      # ----------------------------
      - job: Terraform_Validate
        displayName: "Terraform Validate"
        dependsOn: Terraform_Init
        pool:
          vmImage: ubuntu-latest
        steps:
          - template: jobs/terraform-validate.yml
            parameters:
              workingDirectory: ${{ variables.WORKING_DIR }}

      # ----------------------------
      # âœ… 3. Terraform Plan
      # ----------------------------
      - job: Terraform_Plan
        displayName: "Terraform Plan"
        dependsOn: Terraform_Validate
        pool:
          vmImage: ubuntu-latest
        steps:
          - template: jobs/terraform-plan.yml
            parameters:
              workingDirectory: ${{ variables.WORKING_DIR }}
              databaseType: ${{ parameters.databaseType }}
              eventStorageType: ${{ parameters.eventStorageType }}
              entityStorageType: ${{ parameters.entityStorageType }}
              messagingType: ${{ parameters.messagingType }}

      # ----------------------------
      # âœ… 4. Terraform Apply
      # ----------------------------
      - job: Terraform_Apply
        displayName: "Terraform Apply"
        dependsOn: Terraform_Plan
        pool:
          vmImage: ubuntu-latest
        steps:
          # Protect Apply with manual approval
          - task: ManualValidation@0
            displayName: "ðŸ”’ Approve Terraform Apply"
            inputs:
              notifyUsers: "devops-team@example.com"
              instructions: "Please review the Terraform Plan in Azure DevOps before approving Apply."

          - template: jobs/terraform-apply.yml
            parameters:
              workingDirectory: ${{ variables.WORKING_DIR }}
              databaseType: ${{ parameters.databaseType }}
              eventStorageType: ${{ parameters.eventStorageType }}
              entityStorageType: ${{ parameters.entityStorageType }}
              messagingType: ${{ parameters.messagingType }}
