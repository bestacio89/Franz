- job: terraform-apply
  displayName: "üöÄ Terraform Apply"
  dependsOn: terraform-plan
  pool:
    vmImage: 'ubuntu-latest'

  steps:
    - checkout: self

    # ---------------------------
    # üîé Check Kafka existence
    # ---------------------------
    - script: |
        set -euo pipefail
        echo "üîé Checking if Kafka cluster exists..."
        EXISTING_KAFKA=$(aws kafka list-clusters \
          --region $(AWS_REGION) \
          --query "ClusterInfoList[?ClusterName=='$(KAFKA_CLUSTER_NAME)'].ClusterName" \
          --output text || true)

        if [ -n "$EXISTING_KAFKA" ]; then
          echo "‚úÖ Kafka exists: $EXISTING_KAFKA"
          echo "##vso[task.setvariable variable=KAFKA_EXISTS;isOutput=true]true"
        else
          echo "‚ö†Ô∏è Kafka not found, will be created."
          echo "##vso[task.setvariable variable=KAFKA_EXISTS;isOutput=true]false"
        fi
      displayName: "Check Kafka Cluster"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

    # ---------------------------
    # üîé Check RabbitMQ existence
    # ---------------------------
    - script: |
        set -euo pipefail
        echo "üîé Checking if RabbitMQ broker exists..."
        EXISTING_RABBIT=$(aws mq list-brokers \
          --region $(AWS_REGION) \
          --query "BrokerSummaries[?BrokerName=='$(RABBITMQ_BROKER_NAME)'].BrokerName" \
          --output text || true)

        if [ -n "$EXISTING_RABBIT" ]; then
          echo "‚úÖ RabbitMQ exists: $EXISTING_RABBIT"
          echo "##vso[task.setvariable variable=RABBIT_EXISTS;isOutput=true]true"
        else
          echo "‚ö†Ô∏è RabbitMQ not found, will be created."
          echo "##vso[task.setvariable variable=RABBIT_EXISTS;isOutput=true]false"
        fi
      displayName: "Check RabbitMQ Broker"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

    # ---------------------------
    # üöÄ Apply Terraform
    # ---------------------------
    - download: current
      artifact: terraform-plan

    - script: |
        set -euo pipefail
        echo "üîé Deciding whether to run Terraform Apply..."

        if [ "$(KAFKA_EXISTS)" == "true" ] && [ "$(RABBIT_EXISTS)" == "true" ]; then
          echo "‚è© Skipping Terraform Apply ‚Äî both Kafka & RabbitMQ already exist."
        else
          echo "üöÄ Applying Terraform plan..."
          terraform apply -input=false -auto-approve tfplan
        fi
      displayName: "Terraform Apply"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
